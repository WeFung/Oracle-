<#
  ç”²éª¨æ–‡å…è´¹ARMå®ä¾‹åˆ›å»ºè„šæœ¬ï¼ˆWin11 æœ€ç»ˆç‰ˆï¼‰
  å¡«å…¥ä½ çš„OCID/æŒ‡çº¹/åŒºåŸŸä¿¡æ¯ï¼Œç›´æ¥è¿è¡Œå³å¯
#>
# ========== å·²å¡«å¥½ä½ çš„ç”²éª¨æ–‡ä¿¡æ¯ ==========
$TENANCY_ID = "ocid1.tenancy.oc1..**************"
$USER_ID = "ocid1.user.oc1..************"
$COMPARTMENT_ID = "ocid1.tenancy.oc1..*****************" # Compartmenté»˜è®¤å’Œç§Ÿæˆ·IDä¸€è‡´
$API_FINGERPRINT = "****************************"
# =================================================

# é€‰å®šé…ç½®
$REGION = "us-chicago-1" #ä½ çš„ä¸»åŒºåŸŸ
$AVAILABILITY_DOMAINS = @("Gviv:US-CHICAGO-1-AD-2", "Gviv:US-CHICAGO-1-AD-3", "Gviv:US-CHICAGO-1-AD-1")
$SSH_KEY_PATH = "C:\Users\$env:USERNAME\.oci\oci_ssh_key"
$SSH_PUB_KEY_PATH = "C:\Users\$env:USERNAME\.oci\oci_ssh_key.pub"
$PRIVATE_KEY_FILE = "C:\Users\$env:USERNAME\.oci\oci_api_key.pem" # ä½ çš„APIç§é’¥æ–‡ä»¶è·¯å¾„
$RETRY_WAIT_SECONDS = 1800  # 30åˆ†é’Ÿ
$INSTANCE_SHAPE = "VM.Standard.A1.Flex"
$INSTANCE_CONFIG = '{"ocpus":4,"memoryInGBs":24}'

# ===================== 0. è‡ªåŠ¨æ£€æµ‹å¹¶é…ç½® OCI CLI è·¯å¾„ =====================
Write-Host "`n===================== æ£€æµ‹ OCI CLI ç¯å¢ƒ ======================" -ForegroundColor Green
$ociPaths = @(
    "C:\Users\Lenovo\bin",
    "C:\Program Files\Oracle\OCI CLI\bin",
    "C:\Users\$env:USERNAME\AppData\Local\Oracle\OCI CLI\bin"
)

foreach ($path in $ociPaths) {
    if (Test-Path (Join-Path $path "oci.exe")) {
        $env:PATH = "$path;$env:PATH"
        Write-Host "âœ… è‡ªåŠ¨æ£€æµ‹åˆ° OCI CLIï¼š$path" -ForegroundColor Green
        break
    }
}

if (-not (Get-Command "oci" -ErrorAction SilentlyContinue)) {
    Write-Host "âŒ æœªæ£€æµ‹åˆ° OCI CLIï¼Œè¯·å…ˆå®‰è£…ï¼" -ForegroundColor Red
    Read-Host "æŒ‰ä»»æ„é”®é€€å‡º..."
    exit 1
}

# ===================== 1. è‡ªåŠ¨ç”ŸæˆSSHå¯†é’¥ + å¼ºåˆ¶æ˜¾ç¤ºå…¬é’¥ =====================
Write-Host "`n===================== SSHå¯†é’¥æ£€æŸ¥/ç”Ÿæˆ ======================" -ForegroundColor Green
New-Item -ItemType Directory -Path "C:\Users\$env:USERNAME\.oci" -Force | Out-Null

if (-not (Test-Path $SSH_KEY_PATH) -or -not (Test-Path $SSH_PUB_KEY_PATH)) {
    Write-Host "âš ï¸  æœªæ£€æµ‹åˆ°SSHå¯†é’¥ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸­..." -ForegroundColor Yellow
    ssh-keygen -t rsa -b 2048 -N "" -f $SSH_KEY_PATH 2>&1 | Out-Null
    if (Test-Path $SSH_KEY_PATH -and Test-Path $SSH_PUB_KEY_PATH) {
        Write-Host "âœ… SSHå¯†é’¥è‡ªåŠ¨ç”ŸæˆæˆåŠŸï¼" -ForegroundColor Green
    } else {
        Write-Host "âŒ SSHå¯†é’¥ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œï¼šssh-keygen -t rsa -b 2048 -N "" -f $SSH_KEY_PATH" -ForegroundColor Red
        Read-Host "æŒ‰ä»»æ„é”®é€€å‡º..."
        exit 1
    }
} else {
    Write-Host "âœ… SSHå¯†é’¥å·²å­˜åœ¨" -ForegroundColor Green
}

# å¼ºåˆ¶æ˜¾ç¤ºå…¬é’¥å¹¶ç­‰å¾…ç¡®è®¤
Write-Host "`n===================== å¤åˆ¶SSHå…¬é’¥åˆ°ç”²éª¨æ–‡æ§åˆ¶å° ======================" -ForegroundColor Cyan
Write-Host "ğŸ“‹ ä½ çš„SSHå…¬é’¥å†…å®¹å¦‚ä¸‹ï¼ˆè¯·å®Œæ•´å¤åˆ¶ï¼‰ï¼š" -ForegroundColor White
Get-Content $SSH_PUB_KEY_PATH
Write-Host "`nğŸ’¡ æ“ä½œæ­¥éª¤ï¼š" -ForegroundColor Yellow
Write-Host "1. å¤åˆ¶ä¸Šé¢çš„å…¬é’¥ï¼ˆä» ssh-rsa å¼€å¤´åˆ°ç»“å°¾ï¼‰"
Write-Host "2. ç™»å½•ç”²éª¨æ–‡æ§åˆ¶å° â†’ è®¡ç®— â†’ å®ä¾‹ â†’ åˆ›å»ºå®ä¾‹ â†’ ç²˜è´´å…¬å…±å¯†é’¥"
Write-Host "3. é…ç½®å®Œæˆåï¼Œå›åˆ°è¿™é‡ŒæŒ‰ä»»æ„é”®ç»§ç»­..." -ForegroundColor Yellow
Read-Host "æŒ‰ä»»æ„é”®ç»§ç»­..."

# ===================== 2. Win11 OpenSSLç¯å¢ƒé…ç½® =====================
Write-Host "`n===================== Win11å·¥å…·ç¯å¢ƒæ£€æµ‹ ======================" -ForegroundColor Green
$opensslPaths = @(
    "C:\Program Files\OpenSSL-Win64\bin",
    "C:\Program Files (x86)\OpenSSL-Win32\bin",
    "C:\OpenSSL-win64\bin",
    "C:\Users\Lenovo\AppData\Local\Programs\OpenSSL\bin"
)
$sshPaths = @("C:\Windows\System32\OpenSSH")
foreach ($path in $opensslPaths + $sshPaths) {
    if (Test-Path $path -PathType Container) {
        $env:PATH = "$path;$env:PATH"
        Write-Host "âœ… è‡ªåŠ¨æ·»åŠ ç¯å¢ƒå˜é‡ï¼š$path" -ForegroundColor Green
    }
}
$tools = @("openssl", "ssh-keygen") | Where-Object { $_ -ne "" }
foreach ($tool in $tools) {
    if (-not (Get-Command $tool -ErrorAction SilentlyContinue)) {
        Write-Host "âŒ æœªæ£€æµ‹åˆ° $tool å·¥å…·ï¼Œè¯·å…ˆå®‰è£…ï¼" -ForegroundColor Red
        Read-Host "æŒ‰ä»»æ„é”®é€€å‡º..."
        exit 1
    }
}
Write-Host "âœ… Win11å·¥å…·ç¯å¢ƒæ£€æŸ¥é€šè¿‡" -ForegroundColor Green

# ===================== 3. ç®¡ç†å‘˜æƒé™æ£€æŸ¥ =====================
if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Host "âŒ è¯·ä»¥ã€ç®¡ç†å‘˜èº«ä»½ã€‘è¿è¡ŒWindows PowerShellï¼" -ForegroundColor Red
    Read-Host "æŒ‰ä»»æ„é”®é€€å‡º..."
    exit 1
}

# ===================== 4. APIå¯†é’¥æ£€æŸ¥ =====================
Write-Host "`n===================== APIå¯†é’¥æ£€æŸ¥ ======================" -ForegroundColor Green
if (-not (Test-Path $PRIVATE_KEY_FILE)) {
    Write-Host "âŒ APIç§é’¥æ–‡ä»¶ç¼ºå¤±ï¼š$PRIVATE_KEY_FILE" -ForegroundColor Red
    Write-Host "ğŸ’¡ è¯·å°†ä½ çš„oci_api_key.pemå¤åˆ¶åˆ° C:\Users\$env:USERNAME\.oci\ ç›®å½•ä¸‹" -ForegroundColor Yellow
    Read-Host "æŒ‰ä»»æ„é”®é€€å‡º..."
    exit 1
}
Write-Host "âœ… APIå¯†é’¥æ£€æŸ¥é€šè¿‡" -ForegroundColor Green

# ===================== 5. ç²¾å‡†å€’è®¡æ—¶å‡½æ•° =====================
function Show-PreciseCountdown {
    param(
        [int]$TotalSeconds,
        [string]$NextRetryTime
    )
    $endTime = (Get-Date).AddSeconds($TotalSeconds)
    while ((Get-Date) -lt $endTime) {
        $remaining = $endTime - (Get-Date)
        $minutes = [math]::Floor($remaining.TotalMinutes)
        $seconds = $remaining.Seconds
        Write-Host "`râ³ ä¸‹ä¸€è½®é‡è¯•æ—¶é—´ï¼š$NextRetryTime | å‰©ä½™ï¼š$minutes åˆ† $seconds ç§’ " -NoNewline -ForegroundColor Cyan
        Start-Sleep -Seconds 1
    }
    Write-Host "`r                                                                                " -NoNewline
    Write-Host "`nâœ… å€’è®¡æ—¶ç»“æŸï¼Œå¼€å§‹ä¸‹ä¸€è½®é‡è¯•ï¼`n" -ForegroundColor Green
}

# ===================== 6. OCIç¯å¢ƒé…ç½®ï¼ˆæŠ‘åˆ¶è­¦å‘Šï¼‰ =====================
Write-Host "`n===================== é…ç½®OCIç¯å¢ƒ ======================" -ForegroundColor Green
$env:OCI_CLI_AUTH = "api_key"
$env:OCI_TENANCY_ID = $TENANCY_ID
$env:OCI_USER_ID = $USER_ID
$env:OCI_FINGERPRINT = $API_FINGERPRINT
$env:OCI_PRIVATE_KEY_FILE = $PRIVATE_KEY_FILE
$env:OCI_REGION = $REGION
$env:OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING = "True"
Write-Host "âœ… OCIç¯å¢ƒé…ç½®å®Œæˆ" -ForegroundColor Green

# ===================== 7. æ ¸å¿ƒè‡ªåŠ¨é‡è¯•é€»è¾‘ï¼ˆå®Œæ•´éå†3ä¸ªADï¼‰ =====================
Write-Host "`n===================== å¼€å§‹è‡ªåŠ¨åˆ›å»ºå®ä¾‹ ======================" -ForegroundColor Green
$success = $false
$retryRound = 0

while (-not $success) {
    $retryRound++
    $allADFailed = $true
    $currentRoundTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $nextRetryTime = (Get-Date).AddSeconds($RETRY_WAIT_SECONDS).ToString("yyyy-MM-dd HH:mm:ss")

    Write-Host "`n=====================================================" -ForegroundColor Cyan
    Write-Host "ğŸ”„ ç¬¬ $retryRound è½®é‡è¯• | å¼€å§‹æ—¶é—´ï¼š$currentRoundTime" -ForegroundColor Cyan
    Write-Host "=====================================================" -ForegroundColor Cyan

    # å®Œæ•´éå†3ä¸ªADï¼šAD-2 â†’ AD-3 â†’ AD-1
    foreach ($AD in $AVAILABILITY_DOMAINS) {
        Write-Host "`nğŸ“Œ å°è¯•å¯ç”¨åŸŸï¼š$AD" -ForegroundColor White
        try {
            # 1. è·å–Ubuntu 22.04é•œåƒID
            $imageId = oci compute image list `
                --compartment-id $COMPARTMENT_ID `
                --operating-system "Ubuntu" `
                --operating-system-version "22.04" `
                --query 'data[0].id' `
                --raw-output 2>&1
            
            if (-not $imageId -or $LASTEXITCODE -ne 0) {
                Write-Host "âš ï¸  æœªæ‰¾åˆ°Ubuntu 22.04é•œåƒï¼Œè·³è¿‡è¯¥å¯ç”¨åŸŸ" -ForegroundColor Yellow
                continue
            }

            # 2. è·å–å­ç½‘ID
            $subnetId = oci network subnet list `
                --compartment-id $COMPARTMENT_ID `
                --query 'data[0].id' `
                --raw-output 2>&1
            
            if (-not $subnetId -or $LASTEXITCODE -ne 0) {
                Write-Host "âš ï¸  æœªæ‰¾åˆ°å­ç½‘ï¼Œè·³è¿‡è¯¥å¯ç”¨åŸŸ" -ForegroundColor Yellow
                continue
            }

            # 3. åˆ›å»ºå®ä¾‹
            $instanceId = oci compute instance launch `
                --availability-domain $AD `
                --compartment-id $COMPARTMENT_ID `
                --shape $INSTANCE_SHAPE `
                --shape-config $INSTANCE_CONFIG `
                --image-id $imageId `
                --subnet-id $subnetId `
                --ssh-authorized-keys-file $SSH_PUB_KEY_PATH `
                --display-name "FreeARM_Instance" `
                --wait-for-state RUNNING `
                --query 'data.id' `
                --raw-output 2>&1

            if ($instanceId -and $LASTEXITCODE -eq 0) {
                $publicIp = oci compute instance list-vnics `
                    --instance-id $instanceId `
                    --query 'data[0]."public-ip"' `
                    --raw-output 2>&1
                
                Write-Host "`nğŸ‰ ç¬¬$retryRoundè½®åˆ›å»ºæˆåŠŸï¼" -ForegroundColor Green
                Write-Host "ğŸ”‘ å®ä¾‹IDï¼š$instanceId" -ForegroundColor White
                Write-Host "ğŸŒ å…¬ç½‘IPï¼š$publicIp" -ForegroundColor Cyan
                Write-Host "ğŸ“Œ ç™»å½•å‘½ä»¤ï¼šssh ubuntu@$publicIp -i $SSH_KEY_PATH" -ForegroundColor Cyan
                $success = $true
                $allADFailed = $false
                break
            }
        }
        catch {
            $errorMsg = $_.Exception.Message
            if ($errorMsg -match "Out of host capacity" -or $errorMsg -match "Quota exceeded") {
                Write-Host "âš ï¸  å¯ç”¨åŸŸ$ADï¼šæ— èµ„æºï¼ˆå®¹é‡å·²æ»¡ï¼‰" -ForegroundColor Yellow
            }
            elseif ($errorMsg -match "network" -or $errorMsg -match "subnet") {
                Write-Host "âŒ å¯ç”¨åŸŸ$ADï¼šç½‘ç»œ/å­ç½‘é…ç½®å¼‚å¸¸" -ForegroundColor Red
            }
            elseif ($errorMsg -match "SSH" -or $errorMsg -match "key") {
                Write-Host "âŒ å¯ç”¨åŸŸ$ADï¼šSSHå¯†é’¥æœªé…ç½®ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°å…¬é’¥" -ForegroundColor Red
            }
            else {
                $showMsg = $errorMsg.Substring(0, [Math]::Min(80, $errorMsg.Length))
                Write-Host "âŒ å¯ç”¨åŸŸ$ADï¼šåˆ›å»ºå¤±è´¥ â†’ $showMsg" -ForegroundColor Red
            }
            continue
        }
    }

    # æœ¬è½®æ‰€æœ‰ADéƒ½å¤±è´¥ â†’ 30åˆ†é’Ÿåé‡è¯•
    if (-not $success -and $allADFailed) {
        Write-Host "`nâŒ æœ¬è½®æ‰€æœ‰å¯ç”¨åŸŸéƒ½æ— èµ„æº/åˆ›å»ºå¤±è´¥" -ForegroundColor Red
        Write-Host "â³ ä¸‹ä¸€è½®é‡è¯•æ—¶é—´ï¼š$nextRetryTime" -ForegroundColor Cyan
        Show-PreciseCountdown -TotalSeconds $RETRY_WAIT_SECONDS -NextRetryTime $nextRetryTime
    }
}

Write-Host "`nâœ… è„šæœ¬æ‰§è¡Œå®Œæˆï¼" -ForegroundColor Green
Read-Host "æŒ‰ä»»æ„é”®é€€å‡º..."
