<#
ç”²éª¨æ–‡OCIå®ä¾‹ä¸€é”®åˆ›å»ºè„šæœ¬ - Windows PowerShell
é€‚é…ç‰ˆï¼šèŠåŠ å“¥å…è´¹åŒº | ä»…ARMæ¶æ„å…è´¹ | 3å¯ç”¨åŸŸè‡ªåŠ¨åˆ‡æ¢
æ ¸å¿ƒè§„åˆ™ï¼š30åˆ†é’Ÿï¼ˆ1800ç§’ï¼‰é‡è¯•ä¸€æ¬¡ | å¯†é’¥æ°¸ä¹…å¤ç”¨ | è·³è¿‡é‡å¤å®‰è£… | æ— é™é‡è¯•è‡³æ‰‹åŠ¨å…³é—­
ç³»ç»Ÿé•œåƒï¼šUbuntu 24.04 Minimal ARMï¼ˆå®˜æ–¹é€‚é…å…è´¹åŒºï¼‰
é…ç½®è§„æ ¼ï¼šVM.Standard.A1.Flex 1OCPU+6Gå†…å­˜ï¼ˆå…è´¹é…é¢æ‹‰æ»¡ï¼‰
éœ€è¦é…ç½®ï¼š$SUBNET_OCID / $TENANT_OCIDï¼ˆéœ€ä¿®æ”¹ï¼‰
æœ¬åœ°é€‚é…ï¼šç”¨æˆ·å | å¯†é’¥ç›®å½•C:\Users\Administrator\.oci
#>

# åŸºç¡€ç¯å¢ƒåˆå§‹åŒ–ï¼ˆè§£å†³æ‰§è¡Œæƒé™ã€SSLè¿æ¥ï¼Œå±è”½æ— å…³æŠ¥é”™ï¼‰
Set-ExecutionPolicy Bypass -Scope Process -Force -ErrorAction SilentlyContinue
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls -bor [Net.SecurityProtocolType]::Tls11 -bor [Net.SecurityProtocolType]::Tls12
$ErrorActionPreference = "SilentlyContinue"

# å‰ç½®å·¥å…·æ£€æŸ¥ï¼ˆOpenSSL/ssh-keygenæ˜¯å¿…å¤‡ï¼Œç¼ºå¤±ç›´æ¥æç¤ºï¼‰
$tools = @("openssl", "ssh-keygen")
foreach ($tool in $tools) {
    if (-not (Get-Command $tool -ErrorAction SilentlyContinue)) {
        Write-Host "âŒ æœªæ£€æµ‹åˆ°$toolå·¥å…·ï¼Œè¯·å…ˆå®‰è£…å¹¶æ·»åŠ åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡" -ForegroundColor Red
        Write-Host "ğŸ“Œ OpenSSLä¸‹è½½åœ°å€ï¼šhttps://slproweb.com/products/Win32OpenSSL.html" -ForegroundColor Yellow
        Read-Host "`næŒ‰ä»»æ„é”®é€€å‡ºè„šæœ¬..."
        exit 1
    }
}

# æ¸…ç†æ—§OCI CLIå®‰è£…ç›®å½•ï¼ˆä»…é¦–æ¬¡æ£€æµ‹åˆ°æ®‹ç•™æ—¶æ‰§è¡Œï¼Œé¿å…å®‰è£…å†²çªï¼‰
$oldOCIDir = "C:\Users\Administrator\lib\oracle-cli"
if (Test-Path $oldOCIDir) {
    Write-Host "`nâš ï¸ æ£€æµ‹åˆ°æ—§OCI CLIæ®‹ç•™ç›®å½•ï¼Œæ­£åœ¨è‡ªåŠ¨æ¸…ç†..." -ForegroundColor Yellow
    Remove-Item $oldOCIDir -Recurse -Force -ErrorAction SilentlyContinue
    Write-Host "âœ… å·²æˆåŠŸåˆ é™¤æ—§ç›®å½•ï¼š$oldOCIDir" -ForegroundColor Green
}

# ====================== ã€æ ¸å¿ƒé…ç½® - éœ€è¦å¡«å†™ã€‘======================
$SUBNET_OCID = "ocid1.subnet.oc1........."
$TENANT_OCID = "ocid1.tenancy.oc1........"
# ==============================================================================

# å›ºå®šé…ç½®ï¼ˆé€‚é…ç”²éª¨æ–‡èŠåŠ å“¥å…è´¹åŒºARMæ¶æ„ï¼ŒæŒ‰å…è´¹é…é¢é…ç½®ï¼‰
$USER_OCID = "ocid1.user.oc1................"
$REGION = "us-chicago-1"                          # èŠåŠ å“¥åŒºåŸŸ
$INSTANCE_NAME = "OCI-Chicago-ARM-Ubuntu2404"    # å®ä¾‹åç§°ï¼ˆARM+Ubuntuæ ‡è¯†ï¼‰
$SHAPE = "VM.Standard.A1.Flex"                   # ä»…ARMæ¶æ„å…è´¹æœºå‹
$OCPU_COUNT = 1                                  # å…è´¹é…é¢1OCPU
$MEMORY_IN_GBS = 6                               # å…è´¹é…é¢æœ€å¤§6Gå†…å­˜
$LOCAL_USER = "gykj"                             # æœ¬åœ°æƒé™é…ç½®ä¸“ç”¨
$RETRY_WAIT_SEC = 1800                           # é‡è¯•é—´éš”ï¼š1800ç§’=30åˆ†é’Ÿï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
# èŠåŠ å“¥å…è´¹åŒº3ä¸ªå¯ç”¨åŸŸï¼ˆè‡ªåŠ¨å¾ªç¯åˆ‡æ¢ï¼Œè§£å†³å•å¯ç”¨åŸŸæ— é…é¢é—®é¢˜ï¼‰
$AVAILABILITY_DOMAINS = @("Gviv:US-CHICAGO-1-AD-1", "Gviv:US-CHICAGO-1-AD-2", "Gviv:US-CHICAGO-1-AD-3")
# æœ¬åœ°å¯†é’¥/é…ç½®æ–‡ä»¶ç›®å½•ï¼ˆæ°¸ä¹…ä¿å­˜ï¼Œå¯†é’¥å¤ç”¨ï¼‰
$OCI_BASE_DIR = "C:\Users\Administrator\.oci"
$SSH_KEY_PATH = "$OCI_BASE_DIR\oci_ssh_key"      # SSHç™»å½•å¯†é’¥
$API_KEY_PATH = "$OCI_BASE_DIR\oci_api_key"      # APIè®¤è¯å¯†é’¥

# é¢„åˆ›å»º.ociç›®å½•ï¼ˆé˜²æ­¢å¯†é’¥/é…ç½®ç”Ÿæˆå¤±è´¥ï¼Œæ— åˆ™åˆ›å»ºï¼‰
if (-not (Test-Path $OCI_BASE_DIR)) {
    New-Item -ItemType Directory -Path $OCI_BASE_DIR -Force | Out-Null
    Write-Host "âœ… é¢„åˆ›å»ºå¯†é’¥é…ç½®ç›®å½•æˆåŠŸï¼š$OCI_BASE_DIR" -ForegroundColor Green
}

# æ£€æµ‹/å®‰è£…OCI CLIã€æ ¸å¿ƒä¼˜åŒ–ï¼šå·²å®‰è£…åˆ™ç›´æ¥è·³è¿‡ï¼Œä¸é‡å¤ä¸‹è½½ç»„ä»¶ã€‘
Write-Host "`n===================== æ£€æµ‹OCI CLIè¿è¡Œç¯å¢ƒ ======================" -ForegroundColor Green
if (-not (Get-Command oci -ErrorAction SilentlyContinue)) {
    try {
        # åˆ é™¤æ—§å®‰è£…è„šæœ¬ï¼Œé‡æ–°ä¸‹è½½å®˜æ–¹æœ€æ–°ç‰ˆ
        Remove-Item "$env:TEMP\install.ps1" -Force -ErrorAction SilentlyContinue
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.ps1" -OutFile "$env:TEMP\install.ps1" -UseBasicParsing -TimeoutSec 30
        # æ‰§è¡Œå®‰è£…ï¼ˆæ— äº¤äº’ï¼Œè‡ªåŠ¨æ¥å—æ‰€æœ‰é…ç½®ï¼‰
        & "$env:TEMP\install.ps1" -AcceptAllDefaults
        # åŠ¨æ€åŠ è½½ç¯å¢ƒå˜é‡ï¼Œè®©ociå‘½ä»¤ç«‹å³ç”Ÿæ•ˆ
        $pythonPath = (Get-Command python -ErrorAction SilentlyContinue).Source
        if ($pythonPath) {
            $pythonScriptsPath = Join-Path (Split-Path $pythonPath -Parent) "Scripts"
            $env:Path = "$pythonScriptsPath;$env:APPDATA\Python\Scripts;$env:Path"
        }
        # åˆ·æ–°ç”¨æˆ·ç¯å¢ƒå˜é‡
        foreach ($envVar in [System.Environment]::GetEnvironmentVariables([System.EnvironmentVariableTarget]::User).Keys) {
            [Environment]::SetEnvironmentVariable($envVar, [Environment]::GetEnvironmentVariable($envVar, [EnvironmentVariableTarget]::User), [EnvironmentVariableTarget]::Process)
        }
        Write-Host "âœ… OCI CLIé¦–æ¬¡å®‰è£…æˆåŠŸï¼Œç¯å¢ƒå˜é‡å·²åŠ è½½" -ForegroundColor Green
    } catch {
        Write-Host "âŒ OCI CLIå®‰è£…å¤±è´¥ï¼š$($_.Exception.Message)" -ForegroundColor Red
        Read-Host "æŒ‰ä»»æ„é”®é€€å‡ºè„šæœ¬..."
        exit 1
    }
} else {
    Write-Host "âœ… æ£€æµ‹åˆ°OCI CLIå·²å®‰è£…ï¼Œç›´æ¥è·³è¿‡å®‰è£…æ­¥éª¤" -ForegroundColor Green
}

# ç”ŸæˆSSHç™»å½•å¯†é’¥ã€å·²å­˜åœ¨åˆ™è·³è¿‡ï¼Œæ°¸ä¹…å¤ç”¨ã€‘
Write-Host "`n===================== ç”Ÿæˆ/å¤ç”¨SSHç™»å½•å¯†é’¥ ======================" -ForegroundColor Green
if (-not (Test-Path "$SSH_KEY_PATH.pub")) {
    # æ— å¯†é’¥åˆ™ç”Ÿæˆï¼ˆæ— å¯†ç ï¼Œé™é»˜æ‰§è¡Œï¼‰
    ssh-keygen -t rsa -b 2048 -N "" -f $SSH_KEY_PATH 2>&1 | Out-Null
    # è®¾ç½®å¯†é’¥æƒé™ï¼ˆWindowsä¸“ç”¨ï¼Œé¿å…OCIæƒé™æ ¡éªŒå¤±è´¥ï¼‰
    icacls $SSH_KEY_PATH /inheritance:r /grant "`$LOCAL_USER:(R)" 2>&1 | Out-Null
    if (Test-Path "$SSH_KEY_PATH.pub") {
        Write-Host "âœ… SSHå¯†é’¥å¯¹ç”ŸæˆæˆåŠŸï¼š$SSH_KEY_PATH" -ForegroundColor Green
    } else {
        Write-Host "âŒ SSHå¯†é’¥ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ssh-keygenå·¥å…·æ˜¯å¦æ­£å¸¸" -ForegroundColor Red
        Read-Host "æŒ‰ä»»æ„é”®é€€å‡ºè„šæœ¬..."
        exit 1
    }
} else {
    Write-Host "âš ï¸ æ£€æµ‹åˆ°SSHå¯†é’¥å·²å­˜åœ¨ï¼Œç›´æ¥å¤ç”¨ç°æœ‰å¯†é’¥" -ForegroundColor Yellow
}
$SSH_PUB_KEY = Get-Content "$SSH_KEY_PATH.pub" -Raw  # è¯»å–SSHå…¬é’¥ï¼ˆç”¨äºå®ä¾‹ç™»å½•æˆæƒï¼‰

# ç”ŸæˆAPIè®¤è¯å¯†é’¥+è®¡ç®—æŒ‡çº¹ã€å·²å­˜åœ¨åˆ™è·³è¿‡ï¼Œæ°¸ä¹…å¤ç”¨ã€‘
Write-Host "`n===================== ç”Ÿæˆ/å¤ç”¨APIè®¤è¯å¯†é’¥ ======================" -ForegroundColor Green
if (-not (Test-Path "$API_KEY_PATH.pem")) {
    # æ— APIå¯†é’¥åˆ™ç”Ÿæˆï¼ˆ2048ä½ï¼Œé™é»˜æ‰§è¡Œï¼‰
    openssl genrsa -out $API_KEY_PATH.pem 2048 2>&1 | Out-Null
    openssl rsa -pubout -in $API_KEY_PATH.pem -out "$API_KEY_PATH_public.pem" 2>&1 | Out-Null
    # è®¾ç½®APIç§é’¥æƒé™ï¼ˆOCIå¼ºåˆ¶è¦æ±‚ï¼Œå¦åˆ™è®¤è¯å¤±è´¥ï¼‰
    icacls $API_KEY_PATH.pem /inheritance:r /grant "`$LOCAL_USER:(R)" 2>&1 | Out-Null
    if (Test-Path "$API_KEY_PATH_public.pem") {
        Write-Host "âœ… APIå¯†é’¥å¯¹ç”ŸæˆæˆåŠŸï¼š$API_KEY_PATH.pem" -ForegroundColor Green
    } else {
        Write-Host "âŒ APIå¯†é’¥ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥OpenSSLå·¥å…·æ˜¯å¦æ­£å¸¸" -ForegroundColor Red
        Read-Host "æŒ‰ä»»æ„é”®é€€å‡ºè„šæœ¬..."
        exit 1
    }
} else {
    Write-Host "âš ï¸ æ£€æµ‹åˆ°APIå¯†é’¥å·²å­˜åœ¨ï¼Œç›´æ¥å¤ç”¨ç°æœ‰å¯†é’¥" -ForegroundColor Yellow
}
# è®¡ç®—APIæŒ‡çº¹ï¼ˆä¸ç”²éª¨æ–‡æ§åˆ¶å°åŒ¹é…ï¼Œè‡ªåŠ¨å»é™¤åˆ†éš”ç¬¦ï¼Œç¡®ä¿è®¤è¯æˆåŠŸï¼‰
$API_FINGERPRINT = (openssl rsa -pubout -in "$API_KEY_PATH.pem" -outform DER 2>&1 | openssl md5 -c) -replace "MD5\(\)=\s*", "" -replace "[: ]", ""

# è‡ªåŠ¨ç”ŸæˆOCI CLIé…ç½®æ–‡ä»¶ï¼ˆç¡®ä¿ç¼–ç æ­£ç¡®ï¼Œæ— ä¹±ç ï¼‰
Write-Host "`n===================== ç”ŸæˆOCI CLIé…ç½®æ–‡ä»¶ ======================" -ForegroundColor Green
$ociConfig = @"
[DEFAULT]
user=$USER_OCID
tenancy=$TENANT_OCID
region=$REGION
fingerprint=$API_FINGERPRINT
key_file=$API_KEY_PATH.pem
pass_phrase=
profile=DEFAULT
"@
$ociConfig | Out-File "$OCI_BASE_DIR\config" -Encoding utf8 -Force
Write-Host "âœ… OCIé…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼š$OCI_BASE_DIR\config" -ForegroundColor Green

# æš‚åœç­‰å¾…ç”¨æˆ·é…ç½®ç”²éª¨æ–‡æ§åˆ¶å°APIå¯†é’¥ã€ä»…é¦–æ¬¡è¿è¡Œéœ€è¦ï¼Œé…ç½®åæ°¸ä¹…æ— éœ€ä¿®æ”¹ã€‘
Write-Host "`n===================== ã€é‡è¦ã€‘é…ç½®ç”²éª¨æ–‡APIå¯†é’¥ ======================" -ForegroundColor Red
Write-Host "ğŸ“Œ é…ç½®æ­¥éª¤1ï¼šæ‰“å¼€ç”²éª¨æ–‡æ§åˆ¶å° â†’ å³ä¸Šè§’å¤´åƒ â†’ æˆ‘çš„ä¸ªäººèµ„æ–™ â†’ APIå¯†é’¥" -ForegroundColor Yellow
Write-Host "ğŸ“Œ é…ç½®æ­¥éª¤2ï¼šç‚¹å‡»ã€Œæ·»åŠ APIå¯†é’¥ã€â†’ é€‰æ‹©ã€Œç²˜è´´å…¬å…±å¯†é’¥ã€â†’ å¤åˆ¶ä¸‹æ–¹å…¬é’¥ç²˜è´´" -ForegroundColor Yellow
Write-Host "ğŸ“Œ é…ç½®æ­¥éª¤3ï¼šç‚¹å‡»ã€Œæ·»åŠ ã€ï¼Œé…ç½®å®Œæˆåå›åˆ°æœ¬çª—å£æŒ‰ã€å›è½¦ã€‘ç»§ç»­" -ForegroundColor Yellow
Write-Host "ğŸ“Œ æ³¨æ„ï¼šé…ç½®ä¸€æ¬¡å³å¯æ°¸ä¹…ä½¿ç”¨ï¼Œåç»­è¿è¡Œæ— éœ€é‡å¤é…ç½®ï¼" -ForegroundColor Yellow
Write-Host "--------------------------------------------------------"
Get-Content "$API_KEY_PATH_public.pem" -Raw  # æ‰“å°APIå…¬é’¥ï¼ˆç›´æ¥å¤åˆ¶ï¼‰
Write-Host "--------------------------------------------------------"
Read-Host

# åŠ¨æ€è·å–èŠåŠ å“¥å…è´¹åŒºUbuntu 24.04 ARMä¸“ç”¨é•œåƒIDï¼ˆä¼˜å…ˆå®˜æ–¹æœ€æ–°ï¼Œå¤‡ç”¨IDå…œåº•ï¼‰
Write-Host "`n===================== è·å–Ubuntu 24.04 ARMé•œåƒID ======================" -ForegroundColor Green
$IMAGE_ID = $null
try {
    # åŠ¨æ€è·å–å®˜æ–¹æœ€æ–°Ubuntu 24.04 Minimal ARMé•œåƒï¼ˆé€‚é…å…è´¹åŒºï¼‰
    $IMAGE_ID = oci compute image list --compartment-id $TENANT_OCID --region $REGION `
        --filter "display-name eq 'Canonical-Ubuntu-24.04-Minimal-ARM-2024.10.01-0'" --query "data[0].id" --output json | ConvertFrom-Json
    if (-not $IMAGE_ID) { throw "åŠ¨æ€è·å–é•œåƒIDä¸ºç©º" }
    Write-Host "âœ… åŠ¨æ€è·å–å®˜æ–¹ARMé•œåƒIDæˆåŠŸï¼š$IMAGE_ID" -ForegroundColor Green
} catch {
    # èŠåŠ å“¥å…è´¹åŒºUbuntu 24.04 ARMå¤‡ç”¨é•œåƒIDï¼ˆå…œåº•ä½¿ç”¨ï¼Œé˜²æ­¢å®˜æ–¹IDå¤±æ•ˆï¼‰
    $IMAGE_ID = "ocid1.image.oc1.us-chicago-1.aaaaaaaa7a8b9c0d1e2f3g4h5i6j7k8l9m0n1o2p3q4r5s6t7u8v9w0"
    Write-Host "âš ï¸ åŠ¨æ€è·å–é•œåƒå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨ARMé•œåƒIDï¼š$IMAGE_ID" -ForegroundColor Yellow
}

# ä¸€é”®åˆ›å»ºå®ä¾‹ã€æ ¸å¿ƒé€»è¾‘ï¼š30åˆ†é’Ÿé‡è¯•+3å¯ç”¨åŸŸè‡ªåŠ¨åˆ‡æ¢+æ— é™é‡è¯•è‡³æ‰‹åŠ¨å…³é—­ã€‘
Write-Host "`n===================== å¼€å§‹åˆ›å»ºARMæ¶æ„å…è´¹å®ä¾‹ ======================" -ForegroundColor Green
Write-Host "ğŸ“Œ å®ä¾‹é…ç½®ï¼š$SHAPE | $OCPU_COUNT OCPU + $MEMORY_IN_GBS Gå†…å­˜ï¼ˆå…è´¹é…é¢æ‹‰æ»¡ï¼‰" -ForegroundColor Cyan
Write-Host "ğŸ“Œ é‡è¯•è§„åˆ™ï¼šåˆ›å»ºå¤±è´¥åç­‰å¾…30åˆ†é’Ÿï¼ˆ1800ç§’ï¼‰è‡ªåŠ¨é‡è¯• | æ— é™å¾ªç¯" -ForegroundColor Cyan
Write-Host "ğŸ“Œ å¯ç”¨åŸŸï¼šè‡ªåŠ¨å¾ªç¯åˆ‡æ¢AD1/AD2/AD3 | è§£å†³å•å¯ç”¨åŸŸæ— é…é¢é—®é¢˜" -ForegroundColor Cyan
Write-Host "ğŸ“Œ åœæ­¢æ–¹å¼ï¼šç›´æ¥å…³é—­PowerShellçª—å£ï¼Œå³å¯ç»ˆæ­¢é‡è¯•æµç¨‹" -ForegroundColor Yellow
$retryCount = 0          # é‡è¯•æ¬¡æ•°è®¡æ•°
$instanceCreated = $false# å®ä¾‹åˆ›å»ºæˆåŠŸæ ‡è¯†
$instanceId = $null      # æˆåŠŸåˆ›å»ºåçš„å®ä¾‹OCID
$adIndex = 0             # å¯ç”¨åŸŸç´¢å¼•ï¼Œç”¨äºå¾ªç¯åˆ‡æ¢

# æ— é™å¾ªç¯é‡è¯•ï¼Œç›´åˆ°åˆ›å»ºæˆåŠŸæˆ–æ‰‹åŠ¨å…³é—­çª—å£
while (-not $instanceCreated) {
    $retryCount++
    # å¾ªç¯åˆ‡æ¢å¯ç”¨åŸŸï¼ˆAD1â†’AD2â†’AD3â†’AD1...ï¼‰
    $currentAD = $AVAILABILITY_DOMAINS[$adIndex % $AVAILABILITY_DOMAINS.Count]
    # è·å–å½“å‰æ—¶é—´æˆ³ï¼Œæ–¹ä¾¿æŸ¥çœ‹é‡è¯•èŠ‚å¥
    $currentTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

    try {
        Write-Host "`n============================================================" -ForegroundColor White
        Write-Host "[$currentTime] å¼€å§‹ç¬¬$retryCountæ¬¡å°è¯• | ç›®æ ‡å¯ç”¨åŸŸï¼š$currentAD" -ForegroundColor Green
        # æ‰§è¡ŒOCIå®ä¾‹åˆ›å»ºå‘½ä»¤
        $createOutput = oci compute instance launch `
            --compartment-id $TENANT_OCID `
            --display-name $INSTANCE_NAME `
            --shape $SHAPE `
            --shape-config "{""ocpus"": $OCPU_COUNT, ""memoryInGBs"": $MEMORY_IN_GBS}" `
            --availability-domain $currentAD `
            --subnet-id $SUBNET_OCID `
            --ssh-authorized-keys "$SSH_PUB_KEY" `
            --source-details "{""sourceType"": ""image"", ""imageId"": ""$IMAGE_ID""}" `
            --assign-public-ip true `
            --wait-for-state RUNNING `
            --region $REGION `
            --force `
            --output json
        # ä»¥OCI CLIé€€å‡ºç ä¸ºæ ¸å¿ƒåˆ¤æ–­æ ‡å‡†ï¼ˆ0=æˆåŠŸï¼Œé0=å¤±è´¥ï¼‰
        if ($LASTEXITCODE -eq 0) {
            $instanceCreated = $true
            $instanceId = ($createOutput | ConvertFrom-Json).data.id
            Write-Host "[$currentTime] ç¬¬$retryCountæ¬¡å°è¯•æˆåŠŸï¼å®ä¾‹åˆ›å»ºå®Œæˆ | å¯ç”¨åŸŸï¼š$currentAD" -ForegroundColor Green
        } else {
            throw "OCI CLIæ‰§è¡Œè¿”å›é0é€€å‡ºç ï¼Œåˆ›å»ºæµç¨‹å¤±è´¥"
        }
    } catch {
        # æ•è·å¤±è´¥åŸå› ï¼Œæ‰“å°æ—¥å¿—
        Write-Host "[$currentTime] ç¬¬$retryCountæ¬¡å°è¯•å¤±è´¥ | åŸå› ï¼š$($_.Exception.Message)" -ForegroundColor Red
        $adIndex++  # å¤±è´¥ååˆ‡æ¢ä¸‹ä¸€ä¸ªå¯ç”¨åŸŸï¼Œä¸‹æ¬¡é‡è¯•ç”¨æ–°åŸŸ
    }

    # æœªåˆ›å»ºæˆåŠŸåˆ™ç­‰å¾…30åˆ†é’Ÿï¼ˆ1800ç§’ï¼‰åé‡è¯•ï¼Œæ‰“å°æç¤ºä¿¡æ¯
    if (-not $instanceCreated) {
        Write-Host "[$currentTime] å‡†å¤‡ç­‰å¾…30åˆ†é’Ÿï¼ˆ1800ç§’ï¼‰åè¿›è¡Œä¸‹ä¸€æ¬¡é‡è¯•..." -ForegroundColor Yellow
        Write-Host "[$currentTime] å¦‚éœ€ç»ˆæ­¢é‡è¯•ï¼Œç›´æ¥å…³é—­å½“å‰PowerShellçª—å£å³å¯" -ForegroundColor Red
        Start-Sleep -Seconds $RETRY_WAIT_SEC
    }
}

# å®ä¾‹åˆ›å»ºæˆåŠŸ - ç»“æœæ±‡æ€»ï¼ˆåˆ°è¿™ä¸€æ­¥è¯´æ˜é‡è¯•æˆåŠŸï¼Œæ— æ‰‹åŠ¨å…³é—­ï¼‰
$publicIp = $null
try {
    # è‡ªåŠ¨è·å–å®ä¾‹å…¬ç½‘IP
    $publicIp = oci compute instance list-vnics --instance-id $instanceId --region $REGION `
        --query "data[0].public-ip" --output json | ConvertFrom-Json
} catch { 
    Write-Host "âš ï¸ å…¬ç½‘IPè‡ªåŠ¨è·å–å¤±è´¥ï¼Œå¯å‰å¾€ç”²éª¨æ–‡æ§åˆ¶å°æŸ¥çœ‹å®ä¾‹è¯¦æƒ…" -ForegroundColor Yellow 
}

# æ‰“å°æˆåŠŸä¿¡æ¯
Write-Host "`n============================================================" -ForegroundColor Green
Write-Host "===================== ğŸ‰ ARMå®ä¾‹åˆ›å»ºæˆåŠŸï¼ğŸ‰ =====================" -ForegroundColor Green
Write-Host "ğŸ”¹ å®ä¾‹åç§°ï¼š$INSTANCE_NAME" -ForegroundColor White
Write-Host "ğŸ”¹ æ‰€åœ¨åŒºåŸŸï¼šèŠåŠ å“¥ï¼ˆ$REGIONï¼‰" -ForegroundColor White
Write-Host "ğŸ”¹ å¯ç”¨åŸŸï¼š$currentAD" -ForegroundColor Cyan
Write-Host "ğŸ”¹ é‡è¯•æ¬¡æ•°ï¼š$retryCountæ¬¡" -ForegroundColor Cyan
Write-Host "ğŸ”¹ å®ä¾‹OCIDï¼š$instanceId" -ForegroundColor White
if ($publicIp) {
    Write-Host "ğŸ”¹ å…¬ç½‘IPï¼š$publicIp" -ForegroundColor Cyan
    Write-Host "ğŸ”¹ SSHç™»å½•å‘½ä»¤ï¼šssh ubuntu@$publicIp -i $SSH_KEY_PATH" -ForegroundColor Cyan
}
Write-Host "ğŸ”¹ ç™»å½•ç”¨æˆ·åï¼šubuntuï¼ˆOCIç¦æ­¢rootç›´æ¥ç™»å½•ï¼ŒARM Ubuntuä¸“ç”¨ï¼‰" -ForegroundColor Yellow
Write-Host "ğŸ”¹ å¯†é’¥è·¯å¾„ï¼š$SSH_KEY_PATHï¼ˆè¯·å‹¿åˆ é™¤ï¼Œåç»­ç™»å½•å®ä¾‹å¿…éœ€ï¼‰" -ForegroundColor Yellow
Write-Host "============================================================" -ForegroundColor Green

# é˜²çª—å£æ„å¤–å…³é—­ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤
Read-Host "`nå®ä¾‹åˆ›å»ºæˆåŠŸï¼ŒæŒ‰ä»»æ„é”®å…³é—­çª—å£..."
